<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Interactive Map with ECharts</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      #mapContainer,
      #scatterContainer {
        width: 600px;
        height: 400px;
        border: 1px solid #ccc;
        margin: 10px;
        display: inline-block;
      }
    </style>
  </head>
  <body>
    <div id="mapContainer"></div>
    <div id="scatterContainer"></div>

    <script>
      var mapChart = echarts.init(document.getElementById("mapContainer"));
      var scatterChart = echarts.init(
        document.getElementById("scatterContainer")
      );

      // Define synthetic data for map points and scatter plot
      var mapPoints = {
        // 东莞
        东莞市: {
          value: [113.75944562477805, 23.012540905016007],
          scatter: [
            { distance: 0.435, number: 0.794117647, score: 9, quantity: 28 },
            { distance: 2, number: 1, score: 24, quantity: 35 },
          ],
        },
        // 佛山
        清晖园: {
          value: [113.25505299593833, 22.835835625709908],
          scatter: [
            { distance: 0.435, number: 1.609437912, score: 9, quantity: 4 },
          ],
        },
        佛山科学技术学院: {
          value: [113.26535513024123, 22.863909059295835],
          scatter: [
            { distance: 1.2, number: 1.945910149, score: 9, quantity: 6 },
          ],
        },
        德胜学校: {
          value: [113.2928170051754, 22.793841599724644],
          scatter: [
            { distance: 3, number: 1.386294361, score: 9, quantity: 6 },
          ],
        },
        // 广州
        天河区: {
          value: [113.362, 23.1246],
          scatter: [
            { distance: 126, number: 3, score: 80 },
            { distance: 3, number: 1, score: 70 },
          ],
        },
        // 深圳
        宝安区: {
          value: [113.8831, 22.5533],
          scatter: [
            { distance: 10, number: 3, score: 80 },
            { distance: 3, number: 1, score: 70 },
            { distance: 2, number: 5, score: 40 },
          ],
        },
        南山区: {
          value: [113.9304, 22.5333],
          scatter: [{ distance: 2, number: 5, score: 40 }],
        },
        福田区: {
          value: [114.0545, 22.5229],
          scatter: [{ distance: 2, number: 5, score: 40 }],
        },
      };

      var areaMapping = {
        清晖园: "顺德区",
        佛山科学技术学院: "顺德区",
        德胜学校: "顺德区",
        // Add other mappings here...
      };

      // Modified function to aggregate data for an area
      function getAllScatterDataForArea(areaName) {
        var allData = [];
        for (var key in mapPoints) {
          if (mapPoints.hasOwnProperty(key)) {
            var pointArea = areaMapping[key] || key; // Fallback to key itself if no mapping
            if (pointArea === areaName) {
              allData = allData.concat(mapPoints[key].scatter);
            }
          }
        }
        return allData;
      }

      // Function to set scatter plot option
      function setScatterOption(data) {
        // Transform data for scatter plot (distance and score)
        var transformedData = data.map(function (item) {
          return {
            value: [item.distance, item.score, item.number, item.quantity],
            symbolSize: item.number * 10, // Adjust the multiplier as needed
            // Additional properties for your data can go here
          };
        });

        scatterOption = {
          tooltip: {
            trigger: "item",
            axisPointer: { type: "cross" },
            formatter: function (params) {
              return (
                "Distance: " +
                params.value[0] +
                "km<br>Score: " +
                params.value[1]
              );
            },
          },
          xAxis: {
            name: "Distance to Metro (km)", // Name for x-axis
            min: 0,
            max: 4,
            // Additional xAxis configuration here
          },
          yAxis: {
            name: "Score", // Name for y-axis
            min: 1,
            max: 100,
            // Additional yAxis configuration here
          },
          series: [
            {
              data: transformedData,
              type: "scatter",
              symbolSize: function (val) {
                // Scale the dot size based on the 'number' (3rd element in the array)
                return val[2] * 10; // Adjust this multiplier as needed
              },
              itemStyle: {
                color: "#1f77b4", // Change this color to make the dots visible
              },
              label: {
                normal: {
                  show: true,
                  formatter: function (params) {
                    // The 'number' is now directly in params.value[2]
                    return params.value[3];
                  },
                  position: "inside",
                },
              },
            },
          ],
          graphic: {
            elements: [
              {
                type: "text",
                style: {
                  text: "Inside the dot, the number represents Quantity",
                  fontSize: 14,
                },
                right: 20,
                bottom: 20,
              },
            ],
          },
        };
        scatterChart.setOption(scatterOption);
      }

      // Load the Guangdong GeoJSON data
      // Correct the URL to point to the raw JSON content
      $.getJSON(
        "https://raw.githubusercontent.com/PalaceTony/guangdong_geojson/main/mergedfile.geojson",
        function (geoJson) {
          echarts.registerMap("Guangdong", geoJson);
          // Map option
          mapOption = {
            tooltip: {
              trigger: "item",
              formatter: "{b}",
            },
            series: [
              {
                name: "Guangdong",
                type: "map",
                map: "Guangdong",
                emphasis: {
                  label: {
                    show: true,
                  },
                },
                data: Object.keys(mapPoints).map(function (district) {
                  return { name: district, value: mapPoints[district].value };
                }),
                // MarkPoint for displaying points on the map
                markPoint: {
                  symbolSize: 10,
                  label: {
                    normal: {
                      show: false, // Hide label text
                    },
                    emphasis: {
                      show: false, // Hide label text on hover
                    },
                  },
                  data: Object.keys(mapPoints).map(function (district) {
                    return {
                      name: district,
                      coord: mapPoints[district].value,
                    };
                  }),
                },
              },
            ],
          };

          // Apply the map option to the map chart
          mapChart.setOption(mapOption);
        }
      );

      // Map click event listener
      mapChart.on("click", function (params) {
        var clickedArea = areaMapping[params.name] || params.name; // Use mapping to find the area
        var aggregatedData = getAllScatterDataForArea(clickedArea);
        setScatterOption(aggregatedData);
      });
    </script>
  </body>
</html>
